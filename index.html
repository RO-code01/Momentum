<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momentum: Daily Progress Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* A cooler gray */
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 6px; /* Increased gap */
        }
        .calendar-day {
            aspect-ratio: 1 / 1;
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .calendar-day:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .calendar-day:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        #taskList::-webkit-scrollbar { width: 8px; }
        #taskList::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
        #taskList::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        #taskList::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .task-item-enter {
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* --- Theme Styles --- */
        /* Dark Theme */
        html.dark body { background-color: #111827; color: #d1d5db; }
        html.dark .bg-white { background-color: #1f2937; }
        html.dark .bg-gray-50 { background-color: #111827; }
        html.dark .text-gray-900 { color: #f9fafb; }
        html.dark .text-gray-800 { color: #e5e7eb; }
        html.dark .text-gray-700 { color: #d1d5db; } /* Fix for invisible text */
        html.dark .text-gray-600 { color: #9ca3af; }
        html.dark .text-gray-500 { color: #6b7280; }
        html.dark .border-gray-200 { border-color: #374151; }
        html.dark .border-gray-300 { border-color: #4b5563; }
        html.dark input, html.dark select { background-color: #374151; color: #f9fafb; }
        html.dark ::placeholder { color: #9ca3af; opacity: 1; } /* Fix for invisible placeholder */
        html.dark .hover\:bg-gray-100:hover { background-color: #374151; }
        html.dark .hover\:bg-gray-300:hover { background-color: #4b5563; }
        html.dark .bg-gray-200 { background-color: #374151; }
        html.dark .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2); }
        /* Calendar Dark Colors */
        html.dark .bg-red-300 { background-color: #991b1b; }
        html.dark .bg-yellow-300 { background-color: #b45309; }
        html.dark .bg-green-400 { background-color: #065f46; }
        html.dark .text-black { color: #f9fafb; }
        html.dark .hover\:bg-red-400:hover { background-color: #b91c1c; }
        html.dark .hover\:bg-yellow-400:hover { background-color: #c2410c; }
        html.dark .hover\:bg-green-500:hover { background-color: #047857; }

        /* Neon Crazy Theme - Redesigned for Minimalist Aesthetic */
        html.neon body { 
            background-color: #121212; 
            color: #00e5e5; 
        }
        html.neon .bg-white, html.neon .bg-gray-50 { 
            background-color: #1e1e1e; 
            border: 1px solid #333;
            box-shadow: none;
        }
        html.neon h1, html.neon h2, html.neon h3, html.neon h4 { 
            text-shadow: 0 0 8px rgba(0, 229, 229, 0.4); 
        }
        html.neon .text-gray-900, html.neon .text-gray-800, html.neon .text-gray-700 { 
            color: #00e5e5; 
        }
        html.neon .text-gray-600, html.neon .text-gray-500 { 
            color: #888; 
        }
        html.neon .border-gray-200, html.neon .border-gray-300 { 
            border-color: #333; 
        }
        html.neon input, html.neon select { 
            background-color: #2a2a2a; 
            color: #00e5e5; 
            border: 1px solid #444; 
        }
        html.neon ::placeholder { color: #666; opacity: 1; }
        html.neon .rounded-lg, html.neon .rounded-2xl { 
            border-radius: 8px; /* Restored softer corners */
        }
        html.neon .shadow-xl, html.neon .shadow-md { 
            box-shadow: none; 
        }
        /* Calendar Neon Colors */
        html.neon .bg-gray-200 { 
            background-color: #2a2a2a; 
            border: 1px solid #444; 
        }
        html.neon .bg-red-300 { background-color: #b30059; color: #fff; }
        html.neon .bg-yellow-300 { background-color: #b38600; color: #fff; }
        html.neon .bg-green-400 { background-color: #008080; color: #fff; }
        html.neon .text-black { color: #fff; }

        /* New Theme Switcher Styles */
        #theme-options {
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease-in-out, visibility 0.4s;
            transform: translateX(-20px);
            opacity: 0;
            visibility: hidden;
        }
        #theme-options.open {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }
        #main-theme-btn {
            transition: transform 0.3s ease-in-out;
        }
        #main-theme-btn.open {
            transform: rotate(45deg);
        }
        /* Theme specific styles for new elements */
        html.dark #quote { color: #9ca3af; }
        html.neon #quote { color: #888; }
        html.dark #streak-container { background-color: #064e3b; color: #a7f3d0; }
        html.neon #streak-container { background-color: #008080; color: #fff; border: 1px solid #00e5e5; }

    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">

        <!-- Header -->
        <div class="text-center mb-8">
            <p id="quote" class="text-lg text-gray-500 italic mb-4 transition-colors duration-300 h-8"></p>
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Momentum</h1>
            <p class="text-md text-gray-600 mt-2">Build your streak, find your flow.</p>
            <div id="streak-container" class="mt-6 inline-flex items-center gap-2 bg-green-100 text-green-800 font-bold px-4 py-2 rounded-full text-lg hidden transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M15.23 2.77a2.5 2.5 0 0 1 3.54 0L22 6.27a2.5 2.5 0 0 1 0 3.54l-3.54 3.54a2.5 2.5 0 0 1-3.54 0l-3.54-3.54a2.5 2.5 0 0 1 0-3.54Z"/><path d="M12.63 7.17a2.5 2.5 0 0 1 3.54 0L20 10.67a2.5 2.5 0 0 1 0 3.54l-3.54 3.54a2.5 2.5 0 0 1-3.54 0l-3.54-3.54a2.5 2.5 0 0 1 0-3.54Z"/><path d="M10.03 11.57a2.5 2.5 0 0 1 3.54 0L17.1 15.1a2.5 2.5 0 0 1 0 3.54l-3.54 3.54a2.5 2.5 0 0 1-3.54 0l-3.54-3.54a2.5 2.5 0 0 1 0-3.54Z"/></svg>
                <span id="streak-count">0</span>
                <span>Day Streak!</span>
            </div>
        </div>
        
        <div id="userInfo" class="text-center mb-6 hidden">
            <p class="text-sm text-gray-500">User ID:</p>
            <p id="userIdDisplay" class="font-mono bg-gray-200 text-gray-700 rounded-md px-2 py-1 inline-block text-xs mt-1"></p>
        </div>

        <!-- Calendar -->
        <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6">
            <div class="flex justify-between items-center mb-4">
                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 id="current-month-year" class="text-xl font-semibold text-gray-800"></h2>
                <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
            </div>
            <div class="grid grid-cols-7 gap-2 text-center text-xs font-medium text-gray-500 mb-2">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar-grid" class="calendar-grid"></div>
             <div class="flex justify-center items-center mt-6 space-x-4 text-xs text-gray-600">
                <span>Less Productive</span>
                <div class="w-4 h-4 rounded-sm bg-gray-200 border"></div>
                <div class="w-4 h-4 rounded-sm bg-red-300"></div>
                <div class="w-4 h-4 rounded-sm bg-yellow-300"></div>
                <div class="w-4 h-4 rounded-sm bg-green-400"></div>
                <span>More Productive</span>
            </div>
        </div>

    </div>

    <!-- Theme Switcher -->
    <div id="theme-switcher-container" class="fixed bottom-4 left-4 z-[100] flex items-center gap-3">
        <button id="main-theme-btn" class="w-12 h-12 rounded-full bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 flex items-center justify-center shadow-lg text-2xl">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-300"><path d="M18.37 2.63L14.74 2l-1.06 4.25.98 3.94-2.03 2.03-3.94-.98L4.25 10.2l.63 3.63 4.13 4.13 3.63.63 4.25-1.06-.98-3.94 2.03-2.03 3.94.98L22 9.26z"/><path d="M12 12c-2 0-4.5 2-4.5 4.5s2.5 4.5 4.5 4.5 4.5-2 4.5-4.5S14 12 12 12z"/><path d="M12 2l-2.05 2.05"/></svg>
        </button>
        <div id="theme-options" class="flex gap-2">
            <button data-theme="light" class="theme-btn w-10 h-10 rounded-full bg-white border-2 border-gray-300 flex items-center justify-center shadow-lg text-xl">‚òÄÔ∏è</button>
            <button data-theme="dark" class="theme-btn w-10 h-10 rounded-full bg-gray-800 border-2 border-gray-600 flex items-center justify-center shadow-lg text-xl">üåô</button>
            <button data-theme="neon" class="theme-btn w-10 h-10 rounded-full bg-black border-2 border-purple-500 flex items-center justify-center shadow-lg text-xl">‚ö°Ô∏è</button>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-gray-50 rounded-2xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-gray-900" id="modal-date"></h3>
                <button id="close-modal" class="p-2 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>

            <!-- Daily Progress Bar -->
            <div class="p-6">
                <p class="text-sm font-medium text-gray-600 mb-2">Daily Progress</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="dailyProgressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="p-6 pt-0 max-h-[60vh] overflow-y-auto" id="taskListContainer">
                <!-- Add Task Form -->
                <div class="bg-white p-4 rounded-lg mb-6 border border-gray-200">
                    <h4 class="font-semibold text-lg mb-3 text-gray-700">Add New Task</h4>
                    <form id="addTaskForm" class="space-y-4">
                        <input id="taskDescription" type="text" placeholder="Task description..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <select id="taskType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="units">Unit Based</option>
                                <option value="time">Time Based</option>
                            </select>
                            <div id="unitInputs">
                                <input id="totalUnits" type="number" placeholder="Total Units" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <input id="totalTime" type="number" placeholder="Total Time (in minutes)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition shadow">Add Task</button>
                    </form>
                </div>
                
                <h4 class="font-semibold text-lg mb-3 text-gray-700">Today's Tasks</h4>
                <div id="taskList" class="space-y-3 pr-2">
                    <p id="noTasksMessage" class="text-gray-500 text-center py-4">No tasks yet. Add one to get started!</p>
                </div>
            </div>

            <div class="flex justify-end p-5 border-t border-gray-200">
                 <button id="save-day" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition shadow-md">Save & Close</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let currentDate = new Date();
        let selectedDate = null;
        let dayData = {};
        let currentTasks = [];
        let app, db, auth, userId;

        const quotes = [
            "The secret of getting ahead is getting started.", "The journey of a thousand miles begins with a single step.", "Success is not final, failure is not fatal: it is the courage to continue that counts.",
            "Believe you can and you're halfway there.", "The only way to do great work is to love what you do.", "Act as if what you do makes a difference. It does.", "The difference between ordinary and extraordinary is that little extra.",
            "Your limitation‚Äîit's only your imagination.", "Push yourself, because no one else is going to do it for you.", "Great things never come from comfort zones.", "Dream it. Wish it. Do it.", "Success doesn‚Äôt just find you. You have to go out and get it.",
            "The harder you work for something, the greater you'll feel when you achieve it.", "Dream bigger. Do bigger.", "Don't stop when you're tired. Stop when you're done.", "Wake up with determination. Go to bed with satisfaction.",
            "Do something today that your future self will thank you for.", "It‚Äôs going to be hard, but hard does not mean impossible.", "Don't wait for opportunity. Create it.", "Sometimes we‚Äôre tested not to show our weaknesses, but to discover our strengths.",
            "The key to success is to focus on goals, not obstacles.", "The only limit to our realization of tomorrow will be our doubts of today.", "What you get by achieving your goals is not as important as what you become by achieving your goals.",
            "You don‚Äôt have to be great to start, but you have to start to be great.", "A creative man is motivated by the desire to achieve, not by the desire to beat others.", "A goal is a dream with a deadline.", "The future belongs to those who believe in the beauty of their dreams.",
            "If you can dream it, you can do it.", "You are never too old to set another goal or to dream a new dream.", "Our greatest glory is not in never falling, but in rising every time we fall.",
            "Everything you‚Äôve ever wanted is on the other side of fear.", "Either you run the day or the day runs you.", "The best way to predict the future is to create it.", "I find that the harder I work, the more luck I seem to have.",
            "Success is stumbling from failure to failure with no loss of enthusiasm.", "If you are not willing to risk the usual, you will have to settle for the ordinary.", "All our dreams can come true, if we have the courage to pursue them.",
            "Don‚Äôt watch the clock; do what it does. Keep going.", "The only place where success comes before work is in the dictionary.", "I am not a product of my circumstances. I am a product of my decisions.",
            "The most difficult thing is the decision to act, the rest is merely tenacity.", "You can't build a reputation on what you are going to do.", "There is no substitute for hard work.", "Strive not to be a success, but rather to be of value.",
            "The successful warrior is the average man, with laser-like focus.", "Keep your face always toward the sunshine‚Äîand shadows will fall behind you.", "It is never too late to be what you might have been.",
            "The best revenge is massive success.", "The road to success and the road to failure are almost exactly the same.", "Success is liking yourself, liking what you do, and liking how you do it.",
            "Setting goals is the first step in turning the invisible into the visible.", "Without hustle, talent will only carry you so far.", "Working hard for something we don't care about is called stress; working hard for something we love is called passion.",
            "I'd rather regret the things I've done than regret the things I haven't done.", "You can't have a million-dollar dream with a minimum-wage work ethic.", "If it doesn't challenge you, it won't change you.",
            "The man who has confidence in himself gains the confidence of others.", "If your actions inspire others to dream more, learn more, do more and become more, you are a leader.",
            "The secret of success is to do the common thing uncommonly well.", "You will never always be motivated, so you must learn to be disciplined.", "I have not failed. I've just found 10,000 ways that won't work.",
            "If you want to live a happy life, tie it to a goal, not to people or things.", "What seems to us as bitter trials are often blessings in disguise.", "Don't be afraid to give up the good to go for the great.",
            "No one can make you feel inferior without your consent.", "The whole secret of a successful life is to find out what is one's destiny to do, and then do it.", "If you're going through hell, keep going.",
            "What lies behind us and what lies before us are tiny matters compared to what lies within us.", "The starting point of all achievement is desire.", "Quality is not an act, it is a habit.",
            "A year from now you may wish you had started today.", "The way to get started is to quit talking and begin doing.", "Procrastination is the thief of time.", "Motivation is what gets you started. Habit is what keeps you going.",
            "Perseverance is not a long race; it is many short races one after the other.", "Action is the foundational key to all success.", "It's not whether you get knocked down, it's whether you get up.",
            "The person who says it cannot be done should not interrupt the person who is doing it.", "This is the real secret of life -- to be completely engaged with what you are doing in the here and now. And instead of calling it work, realize it is play.",
            "We can't be afraid of change. You may feel very secure in the pond that you are in, but if you never venture out of it, you will never know that there is such a thing as an ocean, a sea.",
            "Your attitude, not your aptitude, will determine your altitude.", "To be a champion, I think you have to see the big picture. It's not about winning and losing; it's about every day hard work and about thriving on a challenge.",
            "It's not the load that breaks you down, it's the way you carry it.", "The only person you are destined to become is the person you decide to be.", "Don't let yesterday take up too much of today.",
            "It is during our darkest moments that we must focus to see the light.", "Go as far as you can see; when you get there, you'll be able to see further.", "Your talent is God's gift to you. What you do with it is your gift back to God.",
            "Talent wins games, but teamwork and intelligence win championships.", "Don‚Äôt count the days, make the days count.", "An obstacle is often a stepping stone.", "We are what we repeatedly do. Excellence, then, is not an act, but a habit.",
            "The expert in anything was once a beginner."
        ];

        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const taskModal = document.getElementById('taskModal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal');
        const modalDateEl = document.getElementById('modal-date');
        const addTaskForm = document.getElementById('addTaskForm');
        const taskListEl = document.getElementById('taskList');
        const taskTypeSelect = document.getElementById('taskType');
        const unitInputsDiv = document.getElementById('unitInputs');
        const saveDayBtn = document.getElementById('save-day');
        const noTasksMessage = document.getElementById('noTasksMessage');
        const userInfoDiv = document.getElementById('userInfo');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const dailyProgressBar = document.getElementById('dailyProgressBar');

        async function initializeFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            if (!firebaseConfig) { console.error("Firebase config is missing."); return; }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');
            await setPersistence(auth, inMemoryPersistence);
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    // userInfoDiv.classList.remove('hidden'); // This line is commented out to hide the User ID display
                    userIdDisplay.textContent = userId;
                    setupFirestoreListener();
                } else {
                    userInfoDiv.classList.add('hidden');
                }
            });

            try {
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
            } catch (error) { console.error("Authentication failed:", error); }
        }
        
        function setupFirestoreListener() {
            if (!userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/users/${userId}/progress_tracker_v2`;
            
            onSnapshot(collection(db, collectionPath), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" || change.type === "modified") dayData[change.doc.id] = change.doc.data();
                    if (change.type === "removed") delete dayData[change.doc.id];
                });
                renderCalendar(); 
                calculateStreak();
            });
        }

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            currentMonthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.appendChild(document.createElement('div'));

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                dayEl.classList.add('calendar-day', 'flex', 'items-center', 'justify-center', 'font-semibold', 'rounded-lg', 'cursor-pointer', 'shadow-sm');
                
                const data = dayData[dateStr];
                let colorClass = 'bg-gray-200 hover:bg-gray-300 text-gray-700';
                if (data) {
                    if (data.color === 'green') colorClass = 'bg-green-400 hover:bg-green-500 text-white';
                    else if (data.color === 'yellow') colorClass = 'bg-yellow-300 hover:bg-yellow-400 text-black';
                    else if (data.color === 'red') colorClass = 'bg-red-300 hover:bg-red-400 text-white';
                }
                dayEl.classList.add(...colorClass.split(' '));
                
                dayEl.innerHTML = `
                    <span>${day}</span>
                    ${data ? `<div class="tooltip absolute bottom-full mb-2 w-max px-2 py-1 bg-gray-800 text-white text-xs rounded-md shadow-lg">${Math.round(data.completionPercentage)}% done</div>` : ''}
                `;

                dayEl.addEventListener('click', () => openModal(new Date(year, month, day)));
                calendarGrid.appendChild(dayEl);
            }
        }

        function openModal(date) {
            selectedDate = date;
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            modalDateEl.textContent = date.toLocaleDateString('default', { weekday: 'long', month: 'long', day: 'numeric' });
            
            currentTasks = dayData[dateStr] ? JSON.parse(JSON.stringify(dayData[dateStr].tasks)) : [];
            renderTasks();

            taskModal.classList.remove('hidden');
            setTimeout(() => {
                taskModal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal() {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => taskModal.classList.add('hidden'), 300);
        }
        
        function renderTasks() {
            taskListEl.innerHTML = '';
            noTasksMessage.classList.toggle('hidden', currentTasks.length > 0);

            currentTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'p-4 border border-gray-200 rounded-lg flex items-start gap-4 bg-white task-item-enter';
                
                let progressText = task.type === 'units' ? `(${task.completedUnits} / ${task.totalUnits} units)` : `(${task.completedTime} / ${task.totalTime} mins)`;
                
                taskEl.innerHTML = `
                    <input type="checkbox" data-id="${task.id}" ${task.isComplete ? 'checked' : ''} class="task-checkbox h-5 w-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300 mt-1 cursor-pointer">
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800">${task.description}</p>
                        <p class="text-sm text-gray-500">${progressText}</p>
                        <div class="flex items-center gap-2 mt-2">
                            <input type="number" data-id="${task.id}" value="${task.type === 'units' ? task.completedUnits : task.completedTime}" class="task-update-input w-24 px-2 py-1 border border-gray-300 rounded-md text-center focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <span class="text-sm text-gray-500">${task.type === 'units' ? 'units' : 'mins'}</span>
                        </div>
                    </div>
                    <button data-id="${task.id}" class="delete-task-btn p-2 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-500 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                `;
                taskListEl.appendChild(taskEl);
                // Trigger animation
                setTimeout(() => taskEl.style.opacity = '1', 50);
            });
            
            addEventListenersToTasks();
            updateDailyProgress();
        }

        function calculateStreak() {
            const streakContainer = document.getElementById('streak-container');
            const streakCountEl = document.getElementById('streak-count');

            let currentStreak = 0;
            let checkDate = new Date();
            checkDate.setHours(0, 0, 0, 0);
            checkDate.setDate(checkDate.getDate() - 1); // Start checking from yesterday

            while (true) {
                const dateStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;
                
                if (dayData[dateStr] && dayData[dateStr].color === 'green') {
                    currentStreak++;
                    checkDate.setDate(checkDate.getDate() - 1); // Move to the previous day
                } else {
                    break; // Streak is broken
                }
            }

            if (currentStreak > 0) {
                streakCountEl.textContent = currentStreak;
                streakContainer.classList.remove('hidden');
            } else {
                streakContainer.classList.add('hidden');
            }
        }

        function addEventListenersToTasks() {
            document.querySelectorAll('.task-update-input').forEach(input => input.addEventListener('change', (e) => updateTaskProgress(e.target.dataset.id, e.target.value)));
            document.querySelectorAll('.delete-task-btn').forEach(btn => btn.addEventListener('click', (e) => deleteTask(e.currentTarget.dataset.id)));
            document.querySelectorAll('.task-checkbox').forEach(box => box.addEventListener('change', (e) => toggleTaskComplete(e.target.dataset.id, e.target.checked)));
        }
        
        function handleAddTask(e) {
            e.preventDefault();
            const description = document.getElementById('taskDescription').value;
            const type = document.getElementById('taskType').value;
            const totalTime = parseInt(document.getElementById('totalTime').value, 10);
            const totalUnits = type === 'units' ? parseInt(document.getElementById('totalUnits').value, 10) : 0;
            
            if (!description || !totalTime || (type === 'units' && !totalUnits)) return;

            currentTasks.push({ id: crypto.randomUUID(), description, type, totalTime, completedTime: 0, totalUnits, completedUnits: 0, isComplete: false });
            renderTasks();
            addTaskForm.reset();
            handleTaskTypeChange();
            autosaveDayProgress(); // Autosave after adding
        }

        function deleteTask(taskId) {
            currentTasks = currentTasks.filter(t => t.id !== taskId);
            renderTasks();
            autosaveDayProgress(); // Autosave after deleting
        }
        
        function toggleTaskComplete(taskId, isChecked) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;

            task.isComplete = isChecked;
            if(isChecked) {
                if(task.type === 'units') task.completedUnits = task.totalUnits;
                task.completedTime = task.totalTime;
            } else {
                if(task.type === 'units') task.completedUnits = 0;
                task.completedTime = 0;
            }
            renderTasks();
            autosaveDayProgress(); // Autosave after toggling
        }

        function updateTaskProgress(taskId, value) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;
            
            const completedValue = parseInt(value, 10) || 0;
            
            if (task.type === 'units') {
                task.completedUnits = Math.min(completedValue, task.totalUnits);
                task.completedTime = task.totalUnits > 0 ? Math.round((task.completedUnits / task.totalUnits) * task.totalTime) : 0;
                task.isComplete = task.completedUnits >= task.totalUnits;
            } else { // time
                task.completedTime = Math.min(completedValue, task.totalTime);
                task.isComplete = task.completedTime >= task.totalTime;
            }
            renderTasks();
            autosaveDayProgress(); // Autosave after updating progress
        }

        function updateDailyProgress() {
            const { completionPercentage } = calculateProgress();
            dailyProgressBar.style.width = `${completionPercentage}%`;
        }
        
        function calculateProgress() {
            let totalRequiredMinutes = 0, totalCompletedMinutes = 0;
            currentTasks.forEach(task => {
                totalRequiredMinutes += task.totalTime;
                totalCompletedMinutes += task.completedTime;
            });
            const completionPercentage = totalRequiredMinutes > 0 ? (totalCompletedMinutes / totalRequiredMinutes) * 100 : 0;
            return { completionPercentage };
        }

        async function saveDayProgress() {
            // All changes are now autosaved. This button just closes the modal.
            // We'll run one final save for good measure before closing.
            await autosaveDayProgress();
            closeModal();
        }
        
        async function autosaveDayProgress() {
            if (!userId || !selectedDate) {
                console.log("Cannot autosave: User not signed in or no date selected.");
                return;
            }
            const dateStr = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
            
            const { completionPercentage } = calculateProgress();
            
            let color = 'gray';
            if (currentTasks.length > 0) {
                 if (completionPercentage >= 81) color = 'green';
                 else if (completionPercentage >= 70) color = 'yellow';
                 else color = 'red';
            }
            
            const dayDoc = { date: dateStr, tasks: currentTasks, completionPercentage, color };
            
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/progress_tracker_v2`, dateStr);

                // If there are no tasks, delete the document for that day from the database.
                // Otherwise, save (create or update) the document with the current tasks.
                if (currentTasks.length === 0) {
                    // Check if the document exists before trying to delete it
                    if (dayData[dateStr]) {
                        await deleteDoc(docRef);
                        console.log(`Autosaved: Deleted data for ${dateStr}`);
                    }
                } else {
                    await setDoc(docRef, dayDoc);
                    console.log(`Autosaved data for ${dateStr}`);
                }
            } catch (error) {
                console.error("Error during autosave: ", error);
            }
        }

        function handleTaskTypeChange() {
            unitInputsDiv.innerHTML = taskTypeSelect.value === 'units' ? `<input id="totalUnits" type="number" placeholder="Total Units" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">` : '';
        }

        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        closeModalBtn.addEventListener('click', closeModal);
        taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeModal(); });
        addTaskForm.addEventListener('submit', handleAddTask);
        taskTypeSelect.addEventListener('change', handleTaskTypeChange);
        saveDayBtn.addEventListener('click', saveDayProgress);
        
        // --- Theme Logic ---
        function applyTheme(theme) {
            const html = document.documentElement;
            html.classList.remove('dark', 'neon');
            if (theme === 'dark' || theme === 'neon') {
                html.classList.add(theme);
            }
            localStorage.setItem('progress-tracker-theme', theme);
        }

        const mainThemeBtn = document.getElementById('main-theme-btn');
        const themeOptions = document.getElementById('theme-options');

        mainThemeBtn.addEventListener('click', () => {
            themeOptions.classList.toggle('open');
            mainThemeBtn.classList.toggle('open');
        });

        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                applyTheme(btn.dataset.theme);
            });
        });

        function loadTheme() {
            const savedTheme = localStorage.getItem('progress-tracker-theme') || 'light';
            applyTheme(savedTheme);
        }
        
        const QUOTE_INTERVAL = 4 * 60 * 60 * 1000; // 4 hours in milliseconds

        function manageQuoteDisplay() {
            const quoteEl = document.getElementById('quote');
            const storedQuoteData = JSON.parse(localStorage.getItem('momentum-quote'));
            const now = new Date().getTime();

            if (storedQuoteData && (now - storedQuoteData.timestamp < QUOTE_INTERVAL)) {
                quoteEl.textContent = `"${storedQuoteData.quote}"`;
            } else {
                const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                quoteEl.textContent = `"${randomQuote}"`;
                localStorage.setItem('momentum-quote', JSON.stringify({
                    quote: randomQuote,
                    timestamp: now
                }));
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            manageQuoteDisplay();
            setInterval(manageQuoteDisplay, 60 * 1000); // Check every minute
            initializeFirebase();
        });
    </script>
</body>
</html>



