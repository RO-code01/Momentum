<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #111827; /* Softer dark blue-gray */
            --color-surface: #1f2937; /* Lighter surface */
            --color-surface-alt: #374151; /* Even lighter for hover */
            --color-text-header: #f9fafb;
            --color-text-primary: #d1d5db;
            --color-text-secondary: #9ca3af;
            --color-border: #4b5563;
            --color-ring: #38bdf8; /* A brighter, more vibrant blue */
            --color-day-default: #374151;
            --color-day-text: #d1d5db;
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Glassmorphism effect for modals */
        .modal-backdrop {
            background-color: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(8px);
        }
        
        /* Interactive elements */
        .interactive-scale {
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .interactive-scale:hover {
            transform: scale(1.03);
        }
        .interactive-scale:active {
            transform: scale(0.98);
        }
        
        /* Custom scrollbar for a cleaner look */
        #task-list::-webkit-scrollbar {
            width: 6px;
        }
        #task-list::-webkit-scrollbar-track {
            background: var(--color-surface);
        }
        #task-list::-webkit-scrollbar-thumb {
            background: var(--color-surface-alt);
            border-radius: 3px;
        }
        #task-list::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        .calendar-day {
            width: 100%;
            padding-bottom: 100%;
            position: relative;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        .calendar-day-content {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }
        .day-name {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Loader */
        .loader {
            border: 4px solid var(--color-surface-alt);
            border-top: 4px solid var(--color-ring);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* SortableJS styles */
        .sortable-ghost {
            opacity: 0.4;
            background: #374151;
        }
        .task-item {
            cursor: grab;
        }
        .task-item:active {
            cursor: grabbing;
        }

        /* Utility classes */
        .bg-surface { background-color: var(--color-surface); }
        .text-header { color: var(--color-text-header); }
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .border-themed { border-color: var(--color-border); }
        .day-default-bg { background-color: var(--color-day-default); }
        .ring-themed { box-shadow: 0 0 0 2px var(--color-bg), 0 0 0 4px var(--color-ring); }
        .themed-input, .themed-select {
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .themed-input::placeholder { color: var(--color-text-secondary); }
        .themed-input:focus, .themed-select:focus {
            border-color: var(--color-ring);
            box-shadow: 0 0 0 1px var(--color-ring);
            outline: none;
        }
        .task-actions { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .task-item:hover .task-actions { opacity: 1; }

        /* Responsive height for task list */
        .tasks-container {
            height: 75vh;
        }
        @media (max-width: 1023px) {
            .tasks-container {
                height: auto; /* Let it grow naturally on smaller screens */
                max-height: 50vh; /* But don't let it take over */
            }
        }
    </style>
</head>
<body class="antialiased">
    <!-- App Container -->
    <div id="app-container" class="min-h-screen p-2 sm:p-4 lg:p-6">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-6">
            
            <!-- Left Column: Calendar -->
            <div class="lg:col-span-3 bg-surface p-4 sm:p-6 rounded-2xl shadow-2xl border border-themed">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-header" id="month-year-header"></h2>
                    <div class="flex items-center space-x-1">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-surface-alt transition-colors">
                            <svg class="h-5 w-5 text-secondary" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <button id="next-month" class="p-2 rounded-full hover:bg-surface-alt transition-colors">
                            <svg class="h-5 w-5 text-secondary" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="day-name">S</div><div class="day-name">M</div><div class="day-name">T</div><div class="day-name">W</div><div class="day-name">T</div><div class="day-name">F</div><div class="day-name">S</div>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
                <div class="mt-4 flex items-center justify-center space-x-4 text-xs text-secondary">
                    <div class="flex items-center"><span class="w-3 h-3 rounded-sm bg-red-500/80 mr-2"></span>&lt; 70%</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-sm bg-yellow-400/80 mr-2"></span>70-80%</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-sm bg-green-400/80 mr-2"></span>&ge; 81%</div>
                </div>
            </div>

            <!-- Right Column: Daily Tasks -->
            <div class="lg:col-span-2 bg-surface p-4 sm:p-6 rounded-2xl shadow-2xl h-fit border border-themed">
                <div class="tasks-container flex flex-col">
                     <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-lg sm:text-xl font-bold text-header mb-1">Tasks for</h3>
                            <p class="text-secondary font-medium text-sm" id="selected-date-header">Select a date</p>
                        </div>
                        <div id="daily-percentage-container" class="text-right hidden items-center gap-2">
                            <div>
                                <p id="daily-percentage-text" class="text-3xl font-bold text-header">0%</p>
                                <p class="text-xs text-secondary">Completed</p>
                            </div>
                            <button id="goal-insights-btn" class="p-2 rounded-full hover:bg-surface-alt transition-colors interactive-scale hidden">
                                <svg class="h-6 w-6 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="task-list" class="flex-grow space-y-3 mb-4 pr-2 overflow-y-auto"></div>
                    <div id="task-view-actions" class="hidden mt-auto pt-4 border-t border-themed">
                        <button id="add-task-btn" class="w-full bg-sky-500 text-white font-semibold py-3 rounded-lg hover:bg-sky-600 transition-all shadow-lg shadow-sky-900/50 interactive-scale">Add New Task</button>
                        <button id="save-progress-btn" class="w-full mt-3 bg-emerald-500 text-white font-semibold py-3 rounded-lg hover:bg-emerald-600 transition-all shadow-lg shadow-emerald-900/50 interactive-scale">Save Progress</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals (Add, Edit, Confirm Delete, Goal Insights) -->
    <div id="modal-container"></div>
    
    <!-- Loader & Toast -->
    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"><div class="loader"></div></div>
    <div id="toast" class="fixed bottom-5 right-5 bg-surface-alt text-white py-3 px-6 rounded-lg shadow-2xl opacity-0 transform translate-y-2 transition-all duration-300 border border-themed"><p id="toast-message"></p></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyC4Psy8n4mOY8iqntvc4LCh3p_1p5wqU08",
          authDomain: "momentum-16b36.firebaseapp.com",
          projectId: "momentum-16b36",
          storageBucket: "momentum-16b36.firebasestorage.app",
          messagingSenderId: "811360847581",
          appId: "1:811360847581:web:0b7da22006743530aa3d34",
          measurementId: "G-TJRELT8PFW"
        };
        
        let app, auth, db, userId, unsubscribeTaskListener, sortableInstance;
        let isAuthReady = false;
        let currentDate = new Date();
        let selectedDate = null;
        let monthlyData = {};
        let currentTasks = [];

        const ui = {
            monthYearHeader: document.getElementById('month-year-header'),
            calendarGrid: document.getElementById('calendar-grid'),
            selectedDateHeader: document.getElementById('selected-date-header'),
            taskList: document.getElementById('task-list'),
            taskViewActions: document.getElementById('task-view-actions'),
            loader: document.getElementById('loader'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            modalContainer: document.getElementById('modal-container'),
            dailyPercentageContainer: document.getElementById('daily-percentage-container'),
            dailyPercentageText: document.getElementById('daily-percentage-text'),
            goalInsightsBtn: document.getElementById('goal-insights-btn'),
        };

        // --- INITIALIZE APP ---
        async function main() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async user => {
                    if (user) {
                        userId = user.uid;
                        if (!isAuthReady) {
                             isAuthReady = true;
                             await renderCalendar();
                        }
                    } else {
                        signInAnonymously(auth).catch(err => {
                            console.error("Sign-in failed:", err);
                            showToast("Authentication failed.", "error");
                        });
                    }
                });
            } catch (error) {
                console.error("Firebase init failed:", error);
                showToast(error.message, "error");
            }
        }

        // --- HELPERS ---
        const formatDate = date => date.toISOString().split('T')[0];
        const showLoader = isLoading => ui.loader.classList.toggle('hidden', !isLoading);
        const calculateDayStats = (tasks) => {
            let totalMinutesPlanned = 0;
            let totalMinutesCompleted = 0;
            tasks.forEach(task => {
                totalMinutesPlanned += task.totalMinutes || 0;
                if (task.type === 'time') {
                    totalMinutesCompleted += task.completedMinutes || 0;
                } else if (task.type === 'unit') {
                    const minsPerUnit = (task.totalMinutes / task.totalUnits) || 0;
                    totalMinutesCompleted += (task.completedUnits || 0) * minsPerUnit;
                }
            });
            return {
                tasks,
                totalMinutesPlanned,
                totalMinutesCompleted,
                completionPercentage: totalMinutesPlanned > 0 ? Math.round((totalMinutesCompleted / totalMinutesPlanned) * 100) : 0,
            };
        };


        function showToast(message, type = 'success') {
            ui.toastMessage.textContent = message;
            ui.toast.className = ui.toast.className.replace(/bg-red-500|bg-surface-alt/g, '');
            ui.toast.classList.add(type === 'error' ? 'bg-red-500' : 'bg-surface-alt');
            ui.toast.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => ui.toast.classList.add('opacity-0', 'translate-y-2'), 3000);
        }

        function renderDailyStats(tasks) {
            const stats = calculateDayStats(tasks);
            if (tasks && tasks.length > 0) {
                ui.dailyPercentageText.textContent = `${stats.completionPercentage}%`;
                ui.dailyPercentageContainer.style.display = 'flex';
                
                const showGoalButton = stats.totalMinutesPlanned > 0 && stats.completionPercentage < 81;
                ui.goalInsightsBtn.classList.toggle('hidden', !showGoalButton);

            } else {
                ui.dailyPercentageContainer.style.display = 'none';
            }
        }

        // --- CALENDAR ---
        async function fetchMonthlyData(year, month) {
            if (!userId || !isAuthReady) return;
            const monthStr = String(month + 1).padStart(2, '0');
            const q = query(collection(db, `daily_progress`));
            
            try {
                const querySnapshot = await getDocs(q);
                const newMonthlyData = {};
                querySnapshot.forEach(doc => {
                     if (doc.id.startsWith(`${year}-${monthStr}`)) newMonthlyData[doc.id] = doc.data();
                });
                monthlyData = newMonthlyData;
            } catch (error) {
                 console.error("Error fetching monthly data:", error);
                 showToast("Could not load calendar.", "error");
            }
        }

        async function renderCalendar() {
            if (!isAuthReady) return;
            showLoader(true);
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            if (Object.keys(monthlyData).length === 0 || !Object.keys(monthlyData)[0].startsWith(`${year}-${String(month+1).padStart(2,'0')}`)) {
                 await fetchMonthlyData(year, month);
            }
            
            ui.monthYearHeader.textContent = currentDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            ui.calendarGrid.innerHTML = '';
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            ui.calendarGrid.innerHTML = Array(firstDayOfMonth).fill('<div></div>').join('');
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDate(date);
                const dayData = monthlyData[dateStr];

                let bgColor = 'day-default-bg';
                let textColor = 'text-primary';
                
                if (dayData && dayData.completionPercentage != null) {
                    const p = dayData.completionPercentage;
                    if (p >= 81) bgColor = 'bg-green-400/80';
                    else if (p >= 70) bgColor = 'bg-yellow-400/80';
                    else bgColor = 'bg-red-500/80';
                    textColor = 'text-white font-bold';
                }
                
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day ${bgColor} ${formatDate(selectedDate || new Date(0)) === dateStr ? 'ring-themed' : ''}`;
                dayEl.innerHTML = `<div class="calendar-day-content ${textColor}">${day}</div>`;
                dayEl.addEventListener('click', () => handleDateClick(date));
                ui.calendarGrid.appendChild(dayEl);
            }
            showLoader(false);
        }
        
        // --- TASKS ---
        function handleDateClick(date) {
            selectedDate = date;
            ui.selectedDateHeader.textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            ui.taskViewActions.classList.remove('hidden');
            
            if (unsubscribeTaskListener) unsubscribeTaskListener();
            const docRef = doc(db, `daily_progress`, formatDate(date));

            unsubscribeTaskListener = onSnapshot(docRef, docSnap => {
                const dayData = docSnap.exists() ? docSnap.data() : { tasks: [] };
                currentTasks = dayData.tasks || [];
                
                monthlyData[formatDate(date)] = dayData.tasks.length > 0 ? dayData : undefined;

                renderTasks(currentTasks);
                renderDailyStats(currentTasks);
                renderCalendar();
            }, error => {
                console.error("Task listener error:", error);
                showToast("Could not fetch tasks.", "error");
            });
        }
        
        function renderTasks(tasks) {
            ui.taskList.innerHTML = tasks.length === 0 
                ? `<p class="text-secondary italic text-center p-8">No tasks for this day.</p>`
                : tasks.map(task => {
                    const isCompleted = (task.type === 'time' && task.completedMinutes >= task.totalMinutes) ||
                                        (task.type === 'unit' && task.completedUnits >= task.totalUnits);
                    const progressInputHTML = task.type === 'time'
                        ? `<input type="number" data-id="${task.id}" value="${task.completedMinutes || 0}" class="progress-input w-16 text-center rounded-md p-1 themed-input">
                           <span class="text-secondary text-sm">/ ${task.totalMinutes} min</span>`
                        : `<input type="number" data-id="${task.id}" value="${task.completedUnits || 0}" class="progress-input w-16 text-center rounded-md p-1 themed-input">
                           <span class="text-secondary text-sm">/ ${task.totalUnits} units</span>`;

                    return `
                    <div class="bg-surface-alt p-3 rounded-lg border border-themed task-item" data-id="${task.id}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center overflow-hidden">
                                <input type="checkbox" ${isCompleted ? 'checked' : ''} class="h-5 w-5 rounded text-sky-500 focus:ring-sky-500 cursor-not-allowed flex-shrink-0" disabled>
                                <p class="ml-3 font-medium text-primary truncate ${isCompleted ? 'line-through text-gray-500' : ''}">${task.text}</p>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0">
                                <div class="flex items-center space-x-2">${progressInputHTML}</div>
                                <div class="task-actions flex items-center">
                                    <button class="edit-task-btn p-1.5 hover:bg-gray-600 rounded-md" data-id="${task.id}"><svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                                    <button class="delete-task-btn p-1.5 hover:bg-gray-600 rounded-md" data-id="${task.id}"><svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            
            if (sortableInstance) sortableInstance.destroy();
            if (tasks.length > 0) {
                 sortableInstance = new Sortable(ui.taskList, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    delay: 200,
                    delayOnTouchOnly: true,
                    onEnd: async (evt) => {
                        const taskElements = Array.from(ui.taskList.children);
                        const newOrderIds = taskElements.map(el => el.dataset.id);
                        const reorderedTasks = newOrderIds.map(id => currentTasks.find(task => task.id === id)).filter(Boolean);
                        
                        currentTasks = reorderedTasks; // Optimistic update
                        const dayData = calculateDayStats(currentTasks);
                        
                        try {
                            await setDoc(doc(db, `daily_progress`, formatDate(selectedDate)), dayData);
                        } catch (error) {
                             console.error("Error saving new task order:", error);
                             showToast("Failed to save order.", "error");
                        }
                    },
                });
            }
        }
        
        async function saveProgress() {
            if (!selectedDate) return;
            showLoader(true);
            
            const progressInputs = ui.taskList.querySelectorAll('.progress-input');
            const newTasks = currentTasks.map(task => {
                const input = Array.from(progressInputs).find(i => i.dataset.id === task.id);
                if (input) {
                    const completedValue = parseInt(input.value) || 0;
                    if (task.type === 'time') {
                         task.completedMinutes = Math.min(completedValue, task.totalMinutes);
                    } else if (task.type === 'unit') {
                        task.completedUnits = Math.min(completedValue, task.totalUnits);
                    }
                }
                return task;
            });
            
            const dayData = calculateDayStats(newTasks);
            
            try {
                await setDoc(doc(db, `daily_progress`, formatDate(selectedDate)), dayData);
                showToast("Progress saved!");
            } catch (error) {
                console.error("Error saving progress:", error);
                showToast("Failed to save progress.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        // --- MODALS ---
        function renderModal(content) {
            ui.modalContainer.innerHTML = `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop modal-instance">
                ${content}
            </div>`;
            ui.modalContainer.querySelector('.modal-instance').addEventListener('click', e => {
                if (e.target.classList.contains('modal-instance')) closeModal();
            });
        }

        function closeModal() {
            const modal = ui.modalContainer.querySelector('.modal-instance');
            if(modal) {
                modal.firstElementChild.classList.add('opacity-0', 'scale-95');
                modal.classList.add('opacity-0');
                setTimeout(() => ui.modalContainer.innerHTML = '', 200);
            }
        }
        
        function openGoalInsightsModal() {
            const stats = calculateDayStats(currentTasks);
            const { totalMinutesPlanned, totalMinutesCompleted, completionPercentage } = stats;

            const minutesForYellow = Math.ceil((totalMinutesPlanned * 0.70) - totalMinutesCompleted);
            const minutesForGreen = Math.ceil((totalMinutesPlanned * 0.81) - totalMinutesCompleted);

            let contentHTML = '';

            if (completionPercentage < 70) { // In Red zone
                contentHTML = `
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                           <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h6l2-2h2l-2 2z" /></svg>
                        </div>
                        <h3 class="text-xl font-bold text-header mt-4">Next Level: Yellow</h3>
                        <p class="text-secondary my-2">Complete <strong class="text-yellow-400">${minutesForYellow} more minutes</strong> of work to reach 70%.</p>
                    </div>
                    <hr class="border-t-2 border-dashed border-themed my-6">
                    <div class="text-center">
                         <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                           <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6-6l-1.5-1.5a2.25 2.25 0 00-3.182 0l-10.5 10.5a2.25 2.25 0 000 3.182l1.5 1.5a2.25 2.25 0 003.182 0l10.5-10.5a2.25 2.25 0 000-3.182z" /></svg>
                        </div>
                        <h3 class="text-xl font-bold text-header mt-4">Goal: Green</h3>
                        <p class="text-secondary my-2">Complete <strong class="text-green-400">${minutesForGreen} more minutes</strong> of work to reach 81%.</p>
                    </div>
                `;
            } else { // In Yellow zone
                 contentHTML = `
                    <div class="text-center">
                         <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                           <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6-6l-1.5-1.5a2.25 2.25 0 00-3.182 0l-10.5 10.5a2.25 2.25 0 000 3.182l1.5 1.5a2.25 2.25 0 003.182 0l10.5-10.5a2.25 2.25 0 000-3.182z" /></svg>
                        </div>
                        <h3 class="text-xl font-bold text-header mt-4">Goal: Green</h3>
                        <p class="text-secondary my-2">Complete <strong class="text-green-400">${minutesForGreen} more minutes</strong> of work to reach 81%.</p>
                    </div>
                `;
            }

            const modalHTML = `
            <div class="bg-surface rounded-2xl shadow-2xl p-6 w-full max-w-sm border border-themed transform transition-all duration-200 opacity-0 scale-95">
                ${contentHTML}
                <div class="mt-6">
                    <button class="cancel-btn w-full px-5 py-2 bg-surface-alt border-themed text-primary font-semibold rounded-lg hover:bg-gray-600 transition-colors">Close</button>
                </div>
            </div>`;

            renderModal(modalHTML);
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
            setTimeout(() => {
                const modalContent = ui.modalContainer.querySelector('.transform');
                if(modalContent) modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function openTaskModal(taskToEdit = null) {
            const isEditing = !!taskToEdit;
            const modalHTML = `
            <div class="bg-surface rounded-2xl shadow-2xl p-6 w-full max-w-md border border-themed transform transition-all duration-200 opacity-0 scale-95">
                <h2 class="text-2xl font-bold mb-6 text-header">${isEditing ? 'Edit Task' : 'Add New Task'}</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Description</label>
                        <input type="text" id="task-text-input" class="w-full px-4 py-2 rounded-lg themed-input" value="${taskToEdit?.text || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Type</label>
                        <select id="task-type-select" class="w-full px-4 py-2 rounded-lg themed-select">
                            <option value="time" ${taskToEdit?.type === 'time' ? 'selected' : ''}>Time-based</option>
                            <option value="unit" ${taskToEdit?.type === 'unit' ? 'selected' : ''}>Unit-based</option>
                        </select>
                    </div>
                    <div id="time-fields-modal">
                        <label class="block text-sm font-medium text-secondary mb-1">Total Duration (minutes)</label>
                        <input type="number" id="task-minutes-input" class="w-full px-4 py-2 rounded-lg themed-input" value="${(isEditing && taskToEdit.type === 'time') ? taskToEdit.totalMinutes : ''}">
                    </div>
                    <div id="unit-fields-modal" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-1">Total Units</label>
                            <input type="number" id="task-units-input" class="w-full px-4 py-2 rounded-lg themed-input" value="${taskToEdit?.totalUnits || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-1">Total Time for all units (minutes)</label>
                            <input type="number" id="task-total-minutes-for-units-input" class="w-full px-4 py-2 rounded-lg themed-input" value="${(isEditing && taskToEdit.type === 'unit') ? taskToEdit.totalMinutes : ''}">
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button class="cancel-btn px-6 py-2 bg-surface-alt border-themed text-primary font-semibold rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
                    <button class="confirm-task-btn px-6 py-2 bg-sky-500 text-white font-semibold rounded-lg hover:bg-sky-600 transition-colors">${isEditing ? 'Update' : 'Add'}</button>
                </div>
            </div>`;
            renderModal(modalHTML);
            
            const textInput = document.getElementById('task-text-input');
            const typeSelect = document.getElementById('task-type-select');
            const timeFields = document.getElementById('time-fields-modal');
            const unitFields = document.getElementById('unit-fields-modal');
            
            const toggleFields = () => {
                timeFields.classList.toggle('hidden', typeSelect.value === 'unit');
                unitFields.classList.toggle('hidden', typeSelect.value === 'time');
            };
            typeSelect.addEventListener('change', toggleFields);
            toggleFields();

            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
            document.querySelector('.confirm-task-btn').addEventListener('click', () => {
                const text = textInput.value.trim();
                const type = typeSelect.value;
                if (!text) return showToast("Description cannot be empty.", "error");

                let newTaskData = { text, type };
                if (type === 'time') {
                    const totalMinutes = parseInt(document.getElementById('task-minutes-input').value);
                    if (isNaN(totalMinutes) || totalMinutes <= 0) return showToast("Invalid duration.", "error");
                    newTaskData = {...newTaskData, totalMinutes, completedMinutes: taskToEdit?.completedMinutes || 0 };
                } else {
                    const totalUnits = parseInt(document.getElementById('task-units-input').value);
                    const totalMinutesForUnits = parseInt(document.getElementById('task-total-minutes-for-units-input').value);
                    if (isNaN(totalUnits) || totalUnits <= 0 || isNaN(totalMinutesForUnits) || totalMinutesForUnits <= 0) return showToast("Invalid units or time.", "error");
                    newTaskData = {...newTaskData, totalUnits, totalMinutes: totalMinutesForUnits, completedUnits: taskToEdit?.completedUnits || 0 };
                }

                handleSaveTask(isEditing ? {...taskToEdit, ...newTaskData} : {...newTaskData, id: crypto.randomUUID()});
            });

            setTimeout(() => {
                const modalContent = ui.modalContainer.querySelector('.transform');
                if(modalContent) modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        async function handleSaveTask(taskData) {
            let updatedTasks;
            const existingTaskIndex = currentTasks.findIndex(t => t.id === taskData.id);

            if (existingTaskIndex > -1) {
                updatedTasks = [...currentTasks];
                updatedTasks[existingTaskIndex] = taskData;
            } else {
                updatedTasks = [...currentTasks, taskData];
            }
            
            const dayData = calculateDayStats(updatedTasks);
            showLoader(true);
            try {
                const docRef = doc(db, 'daily_progress', formatDate(selectedDate));
                await setDoc(docRef, dayData);
                closeModal();
                showToast(`Task ${existingTaskIndex > -1 ? 'updated' : 'added'}!`);
            } catch (error) {
                console.error("Error saving task:", error);
                showToast("Failed to save task.", "error");
            } finally {
                showLoader(false);
            }
        }

        async function handleDeleteTask(taskId) {
            const updatedTasks = currentTasks.filter(t => t.id !== taskId);
            showLoader(true);
            try {
                const docRef = doc(db, 'daily_progress', formatDate(selectedDate));
                if (updatedTasks.length > 0) {
                    const dayData = calculateDayStats(updatedTasks);
                    await setDoc(docRef, dayData);
                } else {
                    // If no tasks are left, delete the document for that day entirely.
                    await deleteDoc(docRef);
                }
                closeModal();
                showToast("Task deleted.");
            } catch (error) {
                console.error("Error deleting task:", error);
                showToast("Failed to delete task.", "error");
            } finally {
                showLoader(false);
            }
        }

        function openDeleteConfirmation(taskId) {
            const modalHTML = `
            <div class="bg-surface rounded-2xl shadow-2xl p-6 w-full max-w-sm border border-themed transform transition-all duration-200 opacity-0 scale-95">
                <h3 class="text-xl font-bold text-header">Confirm Deletion</h3>
                <p class="text-secondary my-4">Are you sure you want to delete this task? This action cannot be undone.</p>
                <div class="mt-6 flex justify-end space-x-3">
                    <button class="cancel-btn px-5 py-2 bg-surface-alt border-themed text-primary font-semibold rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
                    <button id="confirm-delete-btn" class="px-5 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">Delete</button>
                </div>
            </div>`;
            renderModal(modalHTML);
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', () => handleDeleteTask(taskId));
            setTimeout(() => {
                const modalContent = ui.modalContainer.querySelector('.transform');
                if(modalContent) modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        // --- EVENT LISTENERS ---
        document.getElementById('prev-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            monthlyData = {}; // Clear data for new month
            renderCalendar();
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            monthlyData = {}; // Clear data for new month
            renderCalendar();
        });
        document.getElementById('add-task-btn').addEventListener('click', () => openTaskModal());
        document.getElementById('save-progress-btn').addEventListener('click', saveProgress);
        document.getElementById('goal-insights-btn').addEventListener('click', openGoalInsightsModal);

        
        ui.taskList.addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-task-btn');
            const deleteBtn = e.target.closest('.delete-task-btn');
            if (editBtn) {
                const task = currentTasks.find(t => t.id === editBtn.dataset.id);
                if (task) openTaskModal(task);
            }
            if (deleteBtn) {
                openDeleteConfirmation(deleteBtn.dataset.id);
            }
        });

        main();
    </script>
</body>
</html>

